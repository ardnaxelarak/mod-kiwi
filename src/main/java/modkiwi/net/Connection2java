package modkiwi.net;

import java.io.*;
import java.net.*;
import java.util.*;
import java.util.logging.*;

public class Connection2
{
    private HttpURLConnection connection;
    private List<String> cookies;
    private static final Logger LOG = Logger.getLogger(Connection.class.getName());
    private PrintWriter pw = null;

    public Connection()
    {
        cookies = new LinkedList<String>();
    }

    public Connection(PrintWriter pw)
    {
        this();
        this.pw = pw;
    }

    public HttpURLConnection execute(Request request) throws IOException
    {
        String url = request.getUrl();
        if (request.getRequestType().equals("GET"))
            url = url + "?" + request.getQuery();
        connection = (HttpURLConnection)(new URL(url).openConnection());
        if (pw != null)
            pw.println("Adding cookies...");
        for (String cookie : cookies) {
            connection.addRequestProperty("Cookie", cookie.split(";", 2)[0]);
            if (pw != null)
                pw.println(cookie.split(";", 2)[0]);
        }
        connection.setRequestProperty("Accept-Charset", request.getCharset());
        connection.setRequestMethod(request.getRequestType());

        if (request.getRequestType().equals("POST"))
        {
            connection.setDoOutput(true);
            connection.setRequestProperty("Content-Type", "application/x-www-form-urlencoded;charset=" + request.getCharset());

            try (OutputStream output = connection.getOutputStream()) {
                output.write(request.getQuery().getBytes(request.getCharset()));
            }
        }

        connection.connect();

        if (connection.getResponseCode() != HttpURLConnection.HTTP_OK)
            throw new IOException("Unexpected response code: " + connection.getResponseCode());

        if (pw != null)
        {
            pw.println(connection.getURL().toString());
            for (String cookie : connection.getHeaderFields().get("set-cookie"))
                pw.println(cookie);
        }
        cookies.addAll(connection.getHeaderFields().get("set-cookie"));
        return connection;
    }
}
